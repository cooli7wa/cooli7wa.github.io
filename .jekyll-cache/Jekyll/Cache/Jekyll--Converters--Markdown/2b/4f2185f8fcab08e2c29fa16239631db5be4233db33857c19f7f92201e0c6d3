I"k<p>之前学习了隔离见证，这篇主要介绍下生成区块的流程，中间会有部分前面提到的函数。</p>

<p>generatetoaddress(mining.cpp) 是 cli 用来给特定地址生成区块的命令，从这个函数开始。</p>

<p><img src="/images/md/sc_generate_block_0.png" alt="" /></p>

<p>其中的 DecodeDestination(key_io.cpp) 之前在看隔离见证的时候，讲过后面部分，下面看下前面部分：</p>

<p><img src="/images/md/sc_generate_block_1.png" alt="" /></p>

<p>得到地址之后，函数里生成了 scriptPubkey，使用的是 GetScriptForDestination(standard.cpp):</p>

<p><img src="/images/md/sc_generate_block_2.png" alt="" /></p>

<p>这个函数没什么东西，主要看下 CScriptVisitor(standard.cpp):</p>

<p><img src="/images/md/sc_generate_block_3.png" alt="" /></p>

<p>接下来就是创建主流程了，位于函数 generateBlocks(mining.cpp)：</p>

<p><img src="/images/md/sc_generate_block_4.png" alt="" /></p>

<p><img src="/images/md/sc_generate_block_5.png" alt="" /></p>

<p>这里最重要的函数是 CreateNewBlock(miner.cpp)：</p>

<p><img src="/images/md/sc_generate_block_6.png" alt="" /></p>

<p><img src="/images/md/sc_generate_block_7.png" alt="" /></p>

<p>整个创建区块的流程就这些，其中 addPackageTxs 和 ComputeBlockVersion 涉及到内存池和 BIP9，内容很多，以后单独介绍。</p>

<p>整个流程涉及的文件：</p>

<ul>
  <li>mining.cpp</li>
  <li>key_io.cpp</li>
  <li>standard.cpp</li>
  <li>miner.cpp<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script></li>
</ul>
:ET