<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="比特币-交易体" /><meta name="author" content="cooli7wa" /><meta property="og:locale" content="en" /><meta name="description" content="这次学习下比特币交易体，主要包括交易体的数据结构、签名的几种类型和分别是如何产生的。" /><meta property="og:description" content="这次学习下比特币交易体，主要包括交易体的数据结构、签名的几种类型和分别是如何产生的。" /><link rel="canonical" href="https://cooli7wa.github.io/posts/%E6%AF%94%E7%89%B9%E5%B8%81-%E4%BA%A4%E6%98%93%E4%BD%93/" /><meta property="og:url" content="https://cooli7wa.github.io/posts/%E6%AF%94%E7%89%B9%E5%B8%81-%E4%BA%A4%E6%98%93%E4%BD%93/" /><meta property="og:site_name" content="Cooli7wa" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-08-20T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="比特币-交易体" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@cooli7wa" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"cooli7wa"},"dateModified":"2018-08-20T00:00:00+08:00","datePublished":"2018-08-20T00:00:00+08:00","description":"这次学习下比特币交易体，主要包括交易体的数据结构、签名的几种类型和分别是如何产生的。","headline":"比特币-交易体","mainEntityOfPage":{"@type":"WebPage","@id":"https://cooli7wa.github.io/posts/%E6%AF%94%E7%89%B9%E5%B8%81-%E4%BA%A4%E6%98%93%E4%BD%93/"},"url":"https://cooli7wa.github.io/posts/%E6%AF%94%E7%89%B9%E5%B8%81-%E4%BA%A4%E6%98%93%E4%BD%93/"}</script><title>比特币-交易体 | Cooli7wa</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Cooli7wa"><meta name="application-name" content="Cooli7wa"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/cooli7wa.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Cooli7wa</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/github_username" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cooli7wa67','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>比特币-交易体</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>比特币-交易体</h1><div class="post-meta text-muted"><div> By <em> <a href="https://cooli7wa67@163.com">cooli7wa</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2018-08-20 00:00:00 +0800" data-toggle="tooltip" data-placement="bottom" title="Mon, Aug 20, 2018, 12:00 AM +0800" >Aug 20, 2018</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2969 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p>这次学习下比特币交易体，主要包括交易体的数据结构、签名的几种类型和分别是如何产生的。</p><p>本人知识有限，如有错误和疏漏，请务必指正，多谢。</p><h2 id="前言">前言<a href="#前言" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>交易体位于区块体内，一个区块体内包含很多笔交易，每笔交易都是一个交易体。</p><p>为什么想要介绍下交易体的结构呢，有两个方面的原因：</p><ul><li>交易体内包含签名，而签名的流程是 TEE 钱包需要保护的内容，有的客户需要我们将整个交易体的打包都放到 TA 内部来做，所以这里需要了解整个流程。<li>交易体的签名是有很多种类型的，类型不是指签名的算法，而是签名的范围（具体的后面会介绍），这个跟自己很感兴趣的比特币的合约密切相关，自己也打算近期写个相关的文章，所以这也是一个原因。</ul><p>下面的介绍中，先从详细介绍比特币 transaciton wiki 的一张图开始，并会分析下 bitcoinj 的相关部分代码。</p><h2 id="结构体">结构体<a href="#结构体" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>就是下面这张完整的 transation 的结构图：</p><p><img data-src="https://en.bitcoin.it/w/images/en/e/e1/TxBinaryMap.png" alt="" data-proofer-ignore></p><p>结构体包含四个部分，版本、TxIns、TxOuts 和 锁定时间，TxIns 里可以包含多个 TxIn，TxOuts 也一样。下面就一部分一部分的分解开看。</p><h3 id="1-版本">1. 版本<a href="#1-版本" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="/images/md/transaction_0.png" alt="" data-proofer-ignore></p><p>开头的 Version 就是交易体的版本信息，4 个字节，目前是默认的 01，因为是小端顺序，所以是 01000000。</p><h3 id="2-txins">2. TxIns<a href="#2-txins" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="/images/md/transaction_1.png" alt="" data-proofer-ignore></p><p><img data-src="/images/md/transaction_3.png" alt="" data-proofer-ignore></p><ul><li><p>第一个 VI，TxIn 的总数量，这个是可变长度 Int (Var Int)，1 - 9 个字节，主要是看数量的多少 <img data-src="/images/md/transaction_2.png" alt="" data-proofer-ignore></p><p>如果数量小于 0xFD，那么就只有一个字节长度，本身就是数量的值。</p><p>如果数量大于0xFD，那么第一个字节就是一个标示符，代表的是后面跟着的字节是什么类型的 Int，比如 uint16、uint32、uint64。</p><p>这个就是可变长度 Int，主要是为了缩减数据长度，VI 在整个交易体中出现很多次，如果每个 VI 不做可变长度，而是按照 uint64 的 8 字节固定长度，那么每个 VI 最多浪费了 7 个字节，一个交易体中，就算只有一个输入一个输出，也会浪费掉 3 * 7 = 21 字节，一个 block 算包含 1000 条交易体，那么一个 block 浪费掉的字节数为 21 * 1000 = 21K，现在由 50 多万个 block，大概一共会浪费掉 10 多 G。</p><p>这样的设计确实重要，比特币中还有一些。</p><li><p>TxOutHash，32 字节，我们知道这次花费的币是来源于上一次交易得到的，所以这里指的是上一次交易的<strong>整个交易体的 hash</strong>。如果这个交易体对应的是挖矿奖励（区块记录的第一笔交易），那么因为币是凭空产生的，这里没有来源，所以都是 0 。</p><li><p>TxOutIndex，4 字节，每个交易体可能会包含很多个 TxOut，其中一个是这次花费的币的来源，所以这里指的是上一次交易体中这个 TxOut 的索引。和上一个参数一起，就可以唯一确定出来，币的来源。如果是挖矿奖励，这里是 0xffffffff。</p><li><p>ScriptLen，可变长度（VI），代表的是后面的 script 的总长度。</p><li><p>Script，这里有三种类型，Sig&amp;PubKey、单独的 Signature 或 Arbitrary Data（抽象的数据）。 一般的交易（Standard TxIn），这里是 Sig&amp;PubKey，也就是签名和公钥。 如果花费的是挖矿产生的从未交易过的币（Spend Coinbase），这里是 Signature，就是只提供签名即可，这个跟后面 TxOut 的对应。 如果是挖矿奖励，那么这里可以填入挖矿者自定义的一些数据。</p><p>Script 是如何生成的，后面会介绍。</p><li><p>Sequence，一个序号，和后面会说的 locktime 配合使用。</p><p>一般情况是 locktime 为 0， sequence 是 UINT_MAX，代表交易会被立即执行。</p><p>如果 locktime 不为 0，sequence 是 UINT_MAX， 那么交易也会被立即执行。</p><p>如果 locktime 不为 0， sequence 不是 UINT_MAX， 那么交易会等到 locktime 代表的时间或者块高度时，才会被执行，而且如果在还未执行的时候，出现 sequence 更大的相同交易，那么这次的交易会被取消掉。</p></ul><h3 id="3-txouts">3. TxOuts<a href="#3-txouts" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="/images/md/transaction_4.png" alt="" data-proofer-ignore></p><p><img data-src="/images/md/transaction_5.png" alt="" data-proofer-ignore></p><ul><li>VI，还是代表的是 TxOuts 的数量<li>Value，8 个字节，代表的是发送的比特币的数量，单位是 \(1e^{-8} BTC\)，也就是一亿分之一比特币（ 1 聪）<li>VI，PkScript 长度。<li>Script，有两种类型，Recipient Address 和 Recipient Public Key，分别对应于，Standard TxOut Script 和 Coinbase TxOut Script，代表，普通的交易和挖矿的奖励。 Script 就是赎回脚本了，里面包含脚本操作符和地址或者公钥信息。</ul><h3 id="4-locktime">4. LockTime<a href="#4-locktime" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>锁定时间，这个和之前的 sequence 配合使用。</p><p>LockTime 可以代表两个意思，一个是时间，一个是块数量</p><p><img data-src="/images/md/transaction_6.png" alt="" data-proofer-ignore></p><h2 id="签名">签名<a href="#签名" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>签名就是指 TxIn 里的 Sig 或 Signature，签名需要两个部分，Key 和 待签的数据，Key 很好确定，就是用户的私钥，数据就有一些麻烦，到底应该签哪些内容呢？是不是整个交易体都需要签呢？交易体多个 TxIn 里的签名，要不要带到签名数据里呢？</p><p>这里就要引入比特币的另一个概念，<strong>签名标示</strong>，就直接引用原文了，后面再逐个解释下</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>The SIGHASH flags have two parts, a mode and the ANYONECANPAY modifier:
=&gt; 签名标示包含两个部分，模式和 ANYONECANPAY

SIGHASH_ALL: This is the default. It indicates that everything about the transaction is signed, except for the input scripts. Signing the input scripts as well would obviously make it impossible to construct a transaction, so they are always blanked out. Note, though, that other properties of the input, like the connected output and sequence numbers, are signed; it's only the scripts that are not. Intuitively, it means "I agree to put my money in, if everyone puts their money in and the outputs are this".
=&gt; SIGHASH_ALL，这是钱包默认使用的模式，代表交易体内的所有 In 和 Out 我都关心，都不能随便改变，都签上。

SIGHASH_NONE: The outputs are not signed and can be anything. Use this to indicate "I agree to put my money in, as long as everyone puts their money in, but I don't care what's done with the output". This mode allows others to update the transaction by changing their inputs sequence numbers.
=&gt; SIGHASH_NONE，代表交易体内，我只关心 In， 我只签 In，Out 我不关心，变化了我也不管。这里其他的 sequence 都被设为 0，代表不关心，别人可以更新 sequence。

SIGHASH_SINGLE: Like SIGHASH_NONE, the inputs are signed, but the sequence numbers are blanked, so others can create new versions of the transaction. However, the only output that is signed is the one at the same position as the input. Use this to indicate "I agree, as long as my output is what I want; I don't care about the others".
=&gt; SIGHASH_SINGLE，代表交易体内，我关心 In，并且我还关心位置与我的 In 对应的 Out，这些我签名，其他的 Out 我不关心，另外像　SIGHASH_NONE　一样，别人可以更新 sequence。

The SIGHASH_ANYONECANPAY modifier can be combined with the above three modes. When set, only that input is signed and the other inputs can be anything.
=&gt;　SIGHASH_ANYONECANPAY，这个是一个附加值，可以附加在所有上述的模式上，额外表示，In 里我只关心自己的，其他的 In 我也不关心，别人都可以改。
</pre></table></code></div></div><p>最开始看这个的时候，搞不明白，这样做有什么意义，不就是签名么，怎么还分别人和我自己，不应该都是我自己的么，我自己都签上就好了。</p><p>后来看得多了，才知道，这个是为了比特币的合约准备的。在合约里，很多时候，交易体不是一个人完成的，一个人写完了自己的部分，并不直接发送到比特币网络，而是线下发给别人，别人完成自己的部分，然后传给下一个人，类似这样的流程，这就出现了上面说的，我只关心我自己的，或者我只关心 In，这种需求。大家都做好了之后，或者在某个合适的时候，这个交易体才会被真正发送到比特币网络，被矿工收录到区块内，这里后续有机会可以写一篇文章介绍下。</p><p>知道了签名标示，那么就可以开始介绍签名的具体流程了，这里引用 bitcoinj 的代码，一步步介绍下。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>    <span class="c1">// 这个函数创建的是一个 TxIn，TxIn 内包含签名的创建。</span>
    <span class="kd">public</span> <span class="nc">TransactionInput</span> <span class="nf">addSignedInput</span><span class="o">(</span><span class="nc">TransactionOutPoint</span> <span class="n">prevOut</span><span class="o">,</span> <span class="nc">Script</span> <span class="n">scriptPubKey</span><span class="o">,</span> <span class="nc">ECKey</span> <span class="n">sigKey</span><span class="o">,</span>
                                           <span class="nc">SigHash</span> <span class="n">sigHash</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">anyoneCanPay</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ScriptException</span> <span class="o">{</span>
        <span class="c1">// Verify the API user didn't try to do operations out of order.</span>
        <span class="n">checkState</span><span class="o">(!</span><span class="n">outputs</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(),</span> <span class="s">"Attempting to sign tx without outputs."</span><span class="o">);</span>
        <span class="nc">TransactionInput</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransactionInput</span><span class="o">(</span><span class="n">params</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="n">prevOut</span><span class="o">);</span>
        <span class="n">addInput</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
        <span class="c1">//　hashForSignature，构建了待签名的数据，并求了 hash，主要看看这个函数</span>
        <span class="nc">Sha256Hash</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hashForSignature</span><span class="o">(</span><span class="n">inputs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">scriptPubKey</span><span class="o">,</span> <span class="n">sigHash</span><span class="o">,</span> <span class="n">anyoneCanPay</span><span class="o">);</span>
        <span class="c1">// 将上面求出来的 hash　签名</span>
        <span class="nc">ECKey</span><span class="o">.</span><span class="na">ECDSASignature</span> <span class="n">ecSig</span> <span class="o">=</span> <span class="n">sigKey</span><span class="o">.</span><span class="na">sign</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
        <span class="nc">TransactionSignature</span> <span class="n">txSig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransactionSignature</span><span class="o">(</span><span class="n">ecSig</span><span class="o">,</span> <span class="n">sigHash</span><span class="o">,</span> <span class="n">anyoneCanPay</span><span class="o">);</span>
      <span class="err">　</span><span class="c1">//　创建完整的脚本并加入到 TxIn 内</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">scriptPubKey</span><span class="o">.</span><span class="na">isSentToRawPubKey</span><span class="o">())</span>
            <span class="n">input</span><span class="o">.</span><span class="na">setScriptSig</span><span class="o">(</span><span class="nc">ScriptBuilder</span><span class="o">.</span><span class="na">createInputScript</span><span class="o">(</span><span class="n">txSig</span><span class="o">));</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">scriptPubKey</span><span class="o">.</span><span class="na">isSentToAddress</span><span class="o">())</span>
            <span class="n">input</span><span class="o">.</span><span class="na">setScriptSig</span><span class="o">(</span><span class="nc">ScriptBuilder</span><span class="o">.</span><span class="na">createInputScript</span><span class="o">(</span><span class="n">txSig</span><span class="o">,</span> <span class="n">sigKey</span><span class="o">));</span>
        <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ScriptException</span><span class="o">(</span><span class="s">"Don't know how to sign for this kind of scriptPubKey: "</span> <span class="o">+</span> <span class="n">scriptPubKey</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">input</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre>    <span class="c1">//　这里构建了待签名的数据</span>
    <span class="kd">public</span> <span class="nc">Sha256Hash</span> <span class="nf">hashForSignature</span><span class="o">(</span><span class="kt">int</span> <span class="n">inputIndex</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">connectedScript</span><span class="o">,</span> <span class="kt">byte</span> <span class="n">sigHashType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//　复制了一份 transaction，方便后面的清理等操作</span>
            <span class="nc">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">params</span><span class="o">.</span><span class="na">getDefaultSerializer</span><span class="o">().</span><span class="na">makeTransaction</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bitcoinSerialize</span><span class="o">());</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="c1">//　清理掉所有 TxIn 内的脚本，注意哦，　签名数据是不带已经签好的脚本的</span>
                <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">clearScriptBytes</span><span class="o">();</span>
            <span class="o">}</span>
          <span class="err">　</span><span class="c1">//　这里跟比特币的一个 bug 有关，需要清除掉 OP_CODESEPARATOR</span>
            <span class="n">connectedScript</span> <span class="o">=</span> <span class="nc">Script</span><span class="o">.</span><span class="na">removeAllInstancesOfOp</span><span class="o">(</span><span class="n">connectedScript</span><span class="o">,</span> <span class="nc">ScriptOpCodes</span><span class="o">.</span><span class="na">OP_CODESEPARATOR</span><span class="o">);</span>
          <span class="err">　</span><span class="c1">// 获取当前的 TxIn</span>
            <span class="nc">TransactionInput</span> <span class="n">input</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">inputIndex</span><span class="o">);</span>
            <span class="c1">// 将 TxIn 中的脚本，替换为币的赎回脚本（connectedScript）</span>
            <span class="n">input</span><span class="o">.</span><span class="na">setScriptBytes</span><span class="o">(</span><span class="n">connectedScript</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">((</span><span class="n">sigHashType</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="o">)</span> <span class="o">==</span> <span class="nc">SigHash</span><span class="o">.</span><span class="na">NONE</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 如果是 NONE 模式，因为不关心 TxOut, 所以去掉所有的 Out</span>
                <span class="n">tx</span><span class="o">.</span><span class="na">outputs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">TransactionOutput</span><span class="o">&gt;(</span><span class="mi">0</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">inputIndex</span><span class="o">)</span>
                        <span class="c1">// 将 sequence 设为0，因为不关心</span>
                        <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">setSequenceNumber</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">sigHashType</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="o">)</span> <span class="o">==</span> <span class="nc">SigHash</span><span class="o">.</span><span class="na">SINGLE</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">inputIndex</span> <span class="o">&gt;=</span> <span class="n">tx</span><span class="o">.</span><span class="na">outputs</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="nc">Sha256Hash</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="s">"0100000000000000000000000000000000000000000000000000000000000000"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// 在 SINGLE 模式下，下面这两行是将除了对应位置的 Out，其他的都清零</span>
                <span class="n">tx</span><span class="o">.</span><span class="na">outputs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">TransactionOutput</span><span class="o">&gt;(</span><span class="n">tx</span><span class="o">.</span><span class="na">outputs</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">inputIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inputIndex</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                    <span class="n">tx</span><span class="o">.</span><span class="na">outputs</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TransactionOutput</span><span class="o">(</span><span class="n">tx</span><span class="o">.</span><span class="na">params</span><span class="o">,</span> <span class="n">tx</span><span class="o">,</span> <span class="nc">Coin</span><span class="o">.</span><span class="na">NEGATIVE_SATOSHI</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{}));</span>
                <span class="c1">// 将 sequence 设为0，因为不关心</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">inputIndex</span><span class="o">)</span>
                        <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">setSequenceNumber</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// 如果有 ANYONECANPAY，那么除了当前 TxIn，其他 In 都清零</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">sigHashType</span> <span class="o">&amp;</span> <span class="nc">SigHash</span><span class="o">.</span><span class="na">ANYONECANPAY</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">==</span> <span class="nc">SigHash</span><span class="o">.</span><span class="na">ANYONECANPAY</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">TransactionInput</span><span class="o">&gt;();</span>
                <span class="n">tx</span><span class="o">.</span><span class="na">inputs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// 序列化，并求 hash</span>
            <span class="nc">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnsafeByteArrayOutputStream</span><span class="o">(</span><span class="n">tx</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="no">UNKNOWN_LENGTH</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">tx</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">4</span><span class="o">);</span>
            <span class="n">tx</span><span class="o">.</span><span class="na">bitcoinSerialize</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
            <span class="n">uint32ToByteStreamLE</span><span class="o">(</span><span class="mh">0x000000ff</span> <span class="o">&amp;</span> <span class="n">sigHashType</span><span class="o">,</span> <span class="n">bos</span><span class="o">);</span>
            <span class="nc">Sha256Hash</span> <span class="n">hash</span> <span class="o">=</span> <span class="nc">Sha256Hash</span><span class="o">.</span><span class="na">twiceOf</span><span class="o">(</span><span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
            <span class="n">bos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

            <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>  <span class="c1">// Cannot happen.</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><h2 id="结束">结束<a href="#结束" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>比特币的设计确实考虑了很多东西，能稳定运行这么久，与设计者的知识面和用心程度分不开。希望自己以后也能创造出一套可以广为流传的系统。</p><p>这篇介绍了交易体的结构体和签名，希望对大家有所帮助。<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/study/'>study</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=比特币-交易体 - Cooli7wa&url=https://cooli7wa.github.io/posts/%E6%AF%94%E7%89%B9%E5%B8%81-%E4%BA%A4%E6%98%93%E4%BD%93/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=比特币-交易体 - Cooli7wa&u=https://cooli7wa.github.io/posts/%E6%AF%94%E7%89%B9%E5%B8%81-%E4%BA%A4%E6%98%93%E4%BD%93/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=比特币-交易体 - Cooli7wa&url=https://cooli7wa.github.io/posts/%E6%AF%94%E7%89%B9%E5%B8%81-%E4%BA%A4%E6%98%93%E4%BD%93/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Neural_Networks_And_Deep_Learning_Chap1/"><div class="card-body"> <em class="timeago small" date="2018-02-22 00:00:00 +0800" >Feb 22, 2018</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Neural Networks And Deep Learning Chap1</h3><div class="text-muted small"><p> 原文地址 perceptrons（感知器） 1950s-1960s by scientist Frank Rosenblatt 数学模型： 所有权重参数为w1,w2…，threshold threshold，Dropping the threshold means you’re more willing to go to the festival. 与权重b是同一种意...</p></div></div></a></div><div class="card"> <a href="/posts/Neural_Networks_And_Deep_Learning_Chap2/"><div class="card-body"> <em class="timeago small" date="2018-02-23 00:00:00 +0800" >Feb 23, 2018</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Neural Networks And Deep Learning Chap2</h3><div class="text-muted small"><p> 原文地址 Warm up: a fast matrix-based approach to computing the output from a neural network The two assumptions we need about the cost function 两个假设： \[C=\frac{1}{2n}\sum_x \left \| y(x)-a^{L...</p></div></div></a></div><div class="card"> <a href="/posts/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E4%BA%A4%E6%98%93%E4%BD%93%E5%88%9B%E5%BB%BA/"><div class="card-body"> <em class="timeago small" date="2019-01-04 00:00:00 +0800" >Jan 4, 2019</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>以太坊源码学习-交易体创建</h3><div class="text-muted small"><p> 这篇文章学习以太坊转账中交易生成流程。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // internal/ethapi/api.go // SendTransaction will create a transaction from the given arguments and // tries to sign it with th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E6%AF%94%E7%89%B9%E5%B8%81%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%99%BD%E7%9A%AE%E4%B9%A6/" class="btn btn-outline-primary" prompt="Older"><p>比特币以太坊白皮书</p></a> <a href="/posts/RLP%E5%92%8CVarInt/" class="btn btn-outline-primary" prompt="Newer"><p>RLP和VarInt</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/cooli7wa">Cooli7wa</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
